		Express 中的一个核心概念就是中间件，也叫中间函数。一个中间函数，技术上说就是得到一个请求对象，要么返回给客户端，要么传递给另一个中间函数，你已经见过两个中间函数了 ：一个就是路由句柄函数(req,res)=>{},在 Express 中，所有的路由句柄都是中间函数，因为它需要传入一个请求对象，并且 res.send 给客户端返回数据，res.send 终结了请求反馈闭环；另一个就是 app.use(express.json()),express.json 这个函数返回一个函数对象，一个中间函数，这个函数的作用就是读取请求，如果请求体是一个 JSON 格式对象，它会格式化这个 JSON 对象并以此设置 req.body 属性，这就是运行时发生的事情。
​		当服务器收到一个请求，请求就进入一个管道，我们将这个管道称为请求处理管道，管道之中有一个或多个中间函数，每个函数要么根据请求向客户端返回数据，要么将控制权交给其他的中间函数。在之前的例子中，请求处理管道中有两个中间函数，第一个中间函数是将请求转换为一个 JSON 格式对象，这个情况下它并没有终结请求反馈闭环，这样它就将控制权交给下一个中间函数，就是路由句柄，在路由句柄中，req.body 属性已经被设置好，这样就可以进行一些操作了。最后，以向客户端发送反馈来终结请求反馈闭环。Express有一些内建中间函数，你同样也可以在管道中添加自定义的中间函数。每个服务器获得的请求都会转到中间函数，使用自定义的中间函数，我们可以创建横切关注点(Crosscutting Concerns)，比如我们可以实现登录 验证 认证等功能，所以Express总体来说就是一堆中间函数，下节课我们来看看如何创建自定义中间函数。

![截屏2021-11-11 上午9.02.48](/Users/guansiyu/Desktop/截屏2021-11-11 上午9.02.48.png)

### 创建自定义中间件

现在我们来看看如何创建自定义中间件，在第五行我们添加了JSON中间件，在下面我再次调用app.use()方法，这次我们通过调用use方法在请求处理管道中安插一个中间件。这里我传入一个匿名函数，它有三个参数，request，response和next，next表示管道中下一个中间件的引用，这样能更简单的调用中间件，我这里就打印一下，我们假设在合格中间件处理的是登录功能，处理了登录，我们就调用next来将控制权交给下一个中间件，如果你没有调用next()，你就没有闭合求求反馈闭环，请求就会被无限挂起。记住，在RR闭环中没有传递控制权给下一个中间件，请求会被挂在那里。

```javascript
app.use(express.json())
app.use((req,res,next)=>{
  console.log('Login....')
  next()
})
app.use((req,res,next)=>{
  console.log('Authenticating....')
  next()
})
```

中间件是按顺序调用的，首先是打印Login，然后是打印Authenticating，然后路由就是另一个中间函数了。为了让代码更简明，当我们创建中间件的时候，我们不要将所有代码都写在index文件或者模块当中，我们要将每个中间件放在各自独立的文件中。 

### 总结

现在你应该知道这一句是什么意思了吧

```
app.use(express.json())
```

当我们调用express.json，它返回了一个需3个参数的函数（分别是request response 和 next），它格式化了请求体，如果是一个JSON对象它就设置好req.body属性，然后就会把控制权交给下一个中间件

### 内建中间件

上节课我们介绍了如何自定义中间件，像我之前说的，Express有很多内建的中间件，你已经很熟悉express.json()这个中间件了，它格式化请求体，如果符合JSON格式就设置好req.body属性，还有另一个类似的中间件，那就是urlencoded

```
app.use(express.urlencoded())
```

同样，这样调用的结果返回的是中间件，这个函数的作用是读取通过urlencoded传递的数据，它的请求体格式都是key=value&key=value的键值对格式，这是一种传统的格式，现今不太常用了，基本上如果是一个HTML表单，里面的输入域需要在服务器创建信息，它的请求体就是这个样子的。这就是可以读取请求体中urlencode格式的数据中间件，这个中间件读取这种格式，并设置好req.body属性

```js
app.use(express.urlencoded({extended:true})) //设置扩展属性，这样我们就可以通过urlencoded格式传递数组或复杂的表单数据
```



最后要介绍的一个Express内建中间件是static，我们用它来向外提供静态内容。我们调用express的static方法，这里需要提供一个静态内容的文件夹，我们传入public，我们可以将所有静态内容，比如css，图片到这个文件夹中，我们这就创建这个public文件夹，在里面简单放一个readme.txt的文本文件，有了这个中间件，现在回到浏览器，访问本机3000端口的readme.txt文件就会显示文件内容。

```js
app.use(express.static('public'))
```

 所以使用static这个中间件可以提供静态数据的访问，注意：路径并不用包含oublic目录，static方法是从根目录开始起作用的，下节课我们来看看第三方的中间件

### 第三方中间件

这节课我们来介绍一些Express的第三方中间件，首先访问expressjs.com，在最顶端的资源菜单，可以找到中间件菜单，这就是所有你可以在应用中使用的第三方中间件，这不意味着你要全部用到，因为每个中间件对你应用的运行都会带来影响，如果你不需要中间件的功能，就不要使用，否则只会降低你Express的执行效率，花点时间好好研究一下你的应用需要什么中间件。这个例子中为了最佳实践要用到的是Helmet ，它可以帮助你通过设置http头部来加强安全性。

另一个有用的中间件是Morgan，我们使用Morgan来进行HTTP请求的日志记录，

```bash
$npm i morgan
```

```javascript
const morgan = require('morgan')
app.use(morgan('tiny')) //需要提供字符串参数format 这里使用最简单的格式tiny 你可以查找官方文档找到最适合你的记录方式
```

有了Morgan，每次服务器收到的HTTP请求都会被日志记录，Morgan记录了请求的信息。Morgan默认请求是在控制台记录日志，同样你可以设置它将日志写在日志文件中，同样记住，如果你打开这个功能，对你的运行效率就会有影响，你可能不会在生产环境使用这个功能，或者你只会在特定的场合才开启这个功能，你可以有一个配置文件，在生产环境中的某些特定场景下，你可以短时间开启这个功能然后关闭。下节课我们来看看如果在不同环境诸如开发/测试/生产下工作

